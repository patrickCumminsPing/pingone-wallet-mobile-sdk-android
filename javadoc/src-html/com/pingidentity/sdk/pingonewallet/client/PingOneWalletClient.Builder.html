<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: com.pingidentity.sdk.pingonewallet.client, class: PingOneWalletClient, class: Builder">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package com.pingidentity.sdk.pingonewallet.client;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import android.annotation.SuppressLint;</span>
<span class="source-line-no">004</span><span id="line-4">import android.os.Build;</span>
<span class="source-line-no">005</span><span id="line-5">import android.util.Log;</span>
<span class="source-line-no">006</span><span id="line-6"></span>
<span class="source-line-no">007</span><span id="line-7">import androidx.annotation.NonNull;</span>
<span class="source-line-no">008</span><span id="line-8">import androidx.annotation.Nullable;</span>
<span class="source-line-no">009</span><span id="line-9">import androidx.core.util.Consumer;</span>
<span class="source-line-no">010</span><span id="line-10">import androidx.fragment.app.FragmentActivity;</span>
<span class="source-line-no">011</span><span id="line-11"></span>
<span class="source-line-no">012</span><span id="line-12">import com.google.gson.reflect.TypeToken;</span>
<span class="source-line-no">013</span><span id="line-13">import com.pingidentity.did.sdk.client.ApplicationInstanceCreator;</span>
<span class="source-line-no">014</span><span id="line-14">import com.pingidentity.did.sdk.client.LinkHandler;</span>
<span class="source-line-no">015</span><span id="line-15">import com.pingidentity.did.sdk.client.OpenIDVerifiableCredentialsClient;</span>
<span class="source-line-no">016</span><span id="line-16">import com.pingidentity.did.sdk.client.OpenIDVerifiableCredentialsClient.VerifiablePresentationResult;</span>
<span class="source-line-no">017</span><span id="line-17">import com.pingidentity.did.sdk.client.data.VerifiablePresentationMatcherResult;</span>
<span class="source-line-no">018</span><span id="line-18">import com.pingidentity.did.sdk.client.service.NotFoundException;</span>
<span class="source-line-no">019</span><span id="line-19">import com.pingidentity.did.sdk.client.service.model.ApplicationInstance;</span>
<span class="source-line-no">020</span><span id="line-20">import com.pingidentity.did.sdk.client.service.model.Challenge;</span>
<span class="source-line-no">021</span><span id="line-21">import com.pingidentity.did.sdk.exception.DidException;</span>
<span class="source-line-no">022</span><span id="line-22">import com.pingidentity.did.sdk.exception.InvalidUrlException;</span>
<span class="source-line-no">023</span><span id="line-23">import com.pingidentity.did.sdk.jose.JwksGenerator;</span>
<span class="source-line-no">024</span><span id="line-24">import com.pingidentity.did.sdk.json.JsonUtil;</span>
<span class="source-line-no">025</span><span id="line-25">import com.pingidentity.did.sdk.types.Claim;</span>
<span class="source-line-no">026</span><span id="line-26">import com.pingidentity.did.sdk.types.ClaimReference;</span>
<span class="source-line-no">027</span><span id="line-27">import com.pingidentity.did.sdk.types.Request;</span>
<span class="source-line-no">028</span><span id="line-28">import com.pingidentity.did.sdk.types.Share;</span>
<span class="source-line-no">029</span><span id="line-29">import com.pingidentity.did.sdk.types.VerifiableCredential;</span>
<span class="source-line-no">030</span><span id="line-30">import com.pingidentity.did.sdk.w3c.did.DID;</span>
<span class="source-line-no">031</span><span id="line-31">import com.pingidentity.did.sdk.w3c.did.DidSupport;</span>
<span class="source-line-no">032</span><span id="line-32">import com.pingidentity.did.sdk.w3c.verifiableCredential.InputDescriptor;</span>
<span class="source-line-no">033</span><span id="line-33">import com.pingidentity.did.sdk.w3c.verifiableCredential.VerifiablePresentationRequest;</span>
<span class="source-line-no">034</span><span id="line-34">import com.pingidentity.sdk.pingonewallet.BuildConfig;</span>
<span class="source-line-no">035</span><span id="line-35">import com.pingidentity.sdk.pingonewallet.appevents.AppEvent;</span>
<span class="source-line-no">036</span><span id="line-36">import com.pingidentity.sdk.pingonewallet.appevents.AppEventType;</span>
<span class="source-line-no">037</span><span id="line-37">import com.pingidentity.sdk.pingonewallet.appevents.AppEvents;</span>
<span class="source-line-no">038</span><span id="line-38">import com.pingidentity.sdk.pingonewallet.appevents.CredentialEvent;</span>
<span class="source-line-no">039</span><span id="line-39">import com.pingidentity.sdk.pingonewallet.contracts.PingOneWalletClientContract;</span>
<span class="source-line-no">040</span><span id="line-40">import com.pingidentity.sdk.pingonewallet.contracts.StorageManagerContract;</span>
<span class="source-line-no">041</span><span id="line-41">import com.pingidentity.sdk.pingonewallet.contracts.WalletCallbackHandler;</span>
<span class="source-line-no">042</span><span id="line-42">import com.pingidentity.sdk.pingonewallet.errors.WalletException;</span>
<span class="source-line-no">043</span><span id="line-43">import com.pingidentity.sdk.pingonewallet.storage.StorageErrorHandler;</span>
<span class="source-line-no">044</span><span id="line-44">import com.pingidentity.sdk.pingonewallet.storage.data_repository.DataRepository;</span>
<span class="source-line-no">045</span><span id="line-45">import com.pingidentity.sdk.pingonewallet.storage.data_repository.DataRepositoryImpl;</span>
<span class="source-line-no">046</span><span id="line-46">import com.pingidentity.sdk.pingonewallet.storage.storage_manager.StorageManagerImpl;</span>
<span class="source-line-no">047</span><span id="line-47">import com.pingidentity.sdk.pingonewallet.types.CredentialMatcherResult;</span>
<span class="source-line-no">048</span><span id="line-48">import com.pingidentity.sdk.pingonewallet.types.CredentialRequest;</span>
<span class="source-line-no">049</span><span id="line-49">import com.pingidentity.sdk.pingonewallet.types.CredentialsPresentation;</span>
<span class="source-line-no">050</span><span id="line-50">import com.pingidentity.sdk.pingonewallet.types.PairingRequest;</span>
<span class="source-line-no">051</span><span id="line-51">import com.pingidentity.sdk.pingonewallet.types.regions.PingOneRegion;</span>
<span class="source-line-no">052</span><span id="line-52">import com.pingidentity.sdk.pingonewallet.types.WalletEvents.UnknownEvent;</span>
<span class="source-line-no">053</span><span id="line-53">import com.pingidentity.sdk.pingonewallet.types.WalletEvents.WalletCredentialEvent;</span>
<span class="source-line-no">054</span><span id="line-54">import com.pingidentity.sdk.pingonewallet.types.WalletEvents.WalletError;</span>
<span class="source-line-no">055</span><span id="line-55">import com.pingidentity.sdk.pingonewallet.types.WalletEvents.WalletEvent;</span>
<span class="source-line-no">056</span><span id="line-56">import com.pingidentity.sdk.pingonewallet.types.WalletEvents.WalletPairingEvent;</span>
<span class="source-line-no">057</span><span id="line-57">import com.pingidentity.sdk.pingonewallet.types.WalletMessage.UnknownMessage;</span>
<span class="source-line-no">058</span><span id="line-58">import com.pingidentity.sdk.pingonewallet.types.WalletMessage.credential.CredentialMessage;</span>
<span class="source-line-no">059</span><span id="line-59">import com.pingidentity.sdk.pingonewallet.types.WalletMessage.pairing.PairingPayload;</span>
<span class="source-line-no">060</span><span id="line-60">import com.pingidentity.sdk.pingonewallet.types.PresentationMatcherResult;</span>
<span class="source-line-no">061</span><span id="line-61">import com.pingidentity.sdk.pingonewallet.types.PresentationRequest;</span>
<span class="source-line-no">062</span><span id="line-62">import com.pingidentity.sdk.pingonewallet.types.PresentationResult;</span>
<span class="source-line-no">063</span><span id="line-63">import com.pingidentity.sdk.pingonewallet.types.RequestedKey;</span>
<span class="source-line-no">064</span><span id="line-64">import com.pingidentity.sdk.pingonewallet.types.WalletMessage.pairing.PairingMessage;</span>
<span class="source-line-no">065</span><span id="line-65">import com.pingidentity.sdk.pingonewallet.types.WalletMetadata;</span>
<span class="source-line-no">066</span><span id="line-66">import com.pingidentity.sdk.pingonewallet.utils.ClaimPresentationHelper;</span>
<span class="source-line-no">067</span><span id="line-67">import com.pingidentity.sdk.pingonewallet.utils.CompletionHandler;</span>
<span class="source-line-no">068</span><span id="line-68">import com.pingidentity.sdk.pingonewallet.utils.PollingHelper;</span>
<span class="source-line-no">069</span><span id="line-69">import com.pingidentity.sdk.pingonewallet.utils.WalletMessageParser;</span>
<span class="source-line-no">070</span><span id="line-70"></span>
<span class="source-line-no">071</span><span id="line-71">import org.jose4j.jwk.JsonWebKeySet;</span>
<span class="source-line-no">072</span><span id="line-72"></span>
<span class="source-line-no">073</span><span id="line-73">import java.lang.ref.WeakReference;</span>
<span class="source-line-no">074</span><span id="line-74">import java.util.ArrayList;</span>
<span class="source-line-no">075</span><span id="line-75">import java.util.Arrays;</span>
<span class="source-line-no">076</span><span id="line-76">import java.util.Base64;</span>
<span class="source-line-no">077</span><span id="line-77">import java.util.Collections;</span>
<span class="source-line-no">078</span><span id="line-78">import java.util.HashMap;</span>
<span class="source-line-no">079</span><span id="line-79">import java.util.List;</span>
<span class="source-line-no">080</span><span id="line-80">import java.util.Map;</span>
<span class="source-line-no">081</span><span id="line-81">import java.util.Optional;</span>
<span class="source-line-no">082</span><span id="line-82">import java.util.UUID;</span>
<span class="source-line-no">083</span><span id="line-83">import java.util.stream.Collectors;</span>
<span class="source-line-no">084</span><span id="line-84"></span>
<span class="source-line-no">085</span><span id="line-85">import io.reactivex.rxjava3.android.schedulers.AndroidSchedulers;</span>
<span class="source-line-no">086</span><span id="line-86">import io.reactivex.rxjava3.core.Single;</span>
<span class="source-line-no">087</span><span id="line-87">import io.reactivex.rxjava3.disposables.CompositeDisposable;</span>
<span class="source-line-no">088</span><span id="line-88">import io.reactivex.rxjava3.disposables.Disposable;</span>
<span class="source-line-no">089</span><span id="line-89">import io.reactivex.rxjava3.schedulers.Schedulers;</span>
<span class="source-line-no">090</span><span id="line-90"></span>
<span class="source-line-no">091</span><span id="line-91">@SuppressWarnings("ResultOfMethodCallIgnored")</span>
<span class="source-line-no">092</span><span id="line-92">public class PingOneWalletClient implements PingOneWalletClientContract, DidMessageListener, LinkHandler {</span>
<span class="source-line-no">093</span><span id="line-93"></span>
<span class="source-line-no">094</span><span id="line-94">    public static final String TAG = PingOneWalletClient.class.getCanonicalName();</span>
<span class="source-line-no">095</span><span id="line-95"></span>
<span class="source-line-no">096</span><span id="line-96">    private StorageManagerContract storageManager;</span>
<span class="source-line-no">097</span><span id="line-97">    private DataRepository dataRepository;</span>
<span class="source-line-no">098</span><span id="line-98"></span>
<span class="source-line-no">099</span><span id="line-99">    private WalletCallbackHandler walletCallbackHandler;</span>
<span class="source-line-no">100</span><span id="line-100">    private final OpenIDVerifiableCredentialsClient openIDVerifiableCredentialsClient;</span>
<span class="source-line-no">101</span><span id="line-101"></span>
<span class="source-line-no">102</span><span id="line-102">    private static final Map&lt;String, PingOneRegion&gt; applicationInstanceIdByRegions = new HashMap&lt;&gt;();</span>
<span class="source-line-no">103</span><span id="line-103">    private static final Map&lt;String, ApplicationInstance&gt; applicationInstances = new HashMap&lt;&gt;();</span>
<span class="source-line-no">104</span><span id="line-104">    private final Map&lt;String, NetworkManager&gt; networkManagers = new HashMap&lt;&gt;();</span>
<span class="source-line-no">105</span><span id="line-105"></span>
<span class="source-line-no">106</span><span id="line-106">    private final boolean allowOtherRegions;</span>
<span class="source-line-no">107</span><span id="line-107">    private final String appPackage;</span>
<span class="source-line-no">108</span><span id="line-108"></span>
<span class="source-line-no">109</span><span id="line-109">    private PingOneWalletClient(String appPackage, StorageManagerContract storageManager, WalletCallbackHandler walletCallbackHandler, boolean allowOtherRegions) {</span>
<span class="source-line-no">110</span><span id="line-110">        this.allowOtherRegions = allowOtherRegions;</span>
<span class="source-line-no">111</span><span id="line-111">        this.appPackage = appPackage;</span>
<span class="source-line-no">112</span><span id="line-112">        this.registerStorageManager(storageManager);</span>
<span class="source-line-no">113</span><span id="line-113"></span>
<span class="source-line-no">114</span><span id="line-114">        if (walletCallbackHandler != null) {</span>
<span class="source-line-no">115</span><span id="line-115">            this.registerCallbackHandler(walletCallbackHandler);</span>
<span class="source-line-no">116</span><span id="line-116">        }</span>
<span class="source-line-no">117</span><span id="line-117"></span>
<span class="source-line-no">118</span><span id="line-118">        loadApplicationInstances();</span>
<span class="source-line-no">119</span><span id="line-119">        initNetworkManagers();</span>
<span class="source-line-no">120</span><span id="line-120">        openIDVerifiableCredentialsClient = new OpenIDVerifiableCredentialsClient(DidSupport.INSTANCE, this);</span>
<span class="source-line-no">121</span><span id="line-121">    }</span>
<span class="source-line-no">122</span><span id="line-122"></span>
<span class="source-line-no">123</span><span id="line-123"></span>
<span class="source-line-no">124</span><span id="line-124">    private void initNetworkManagers() {</span>
<span class="source-line-no">125</span><span id="line-125">        applicationInstanceIdByRegions.forEach((s, pingOneRegion) -&gt; {</span>
<span class="source-line-no">126</span><span id="line-126">            ApplicationInstance applicationInstance = applicationInstances.get(s);</span>
<span class="source-line-no">127</span><span id="line-127">            if (applicationInstance == null) return;</span>
<span class="source-line-no">128</span><span id="line-128">            initNetworkManagerFor(pingOneRegion, applicationInstance);</span>
<span class="source-line-no">129</span><span id="line-129">        });</span>
<span class="source-line-no">130</span><span id="line-130">    }</span>
<span class="source-line-no">131</span><span id="line-131"></span>
<span class="source-line-no">132</span><span id="line-132">    private void loadApplicationInstances() {</span>
<span class="source-line-no">133</span><span id="line-133">        dataRepository.getRegions().forEach(region -&gt; {</span>
<span class="source-line-no">134</span><span id="line-134">            ApplicationInstance appInstance = dataRepository.getApplicationInstance(region);</span>
<span class="source-line-no">135</span><span id="line-135">            if (appInstance != null) {</span>
<span class="source-line-no">136</span><span id="line-136">                setApplicationInstanceFor(region, appInstance);</span>
<span class="source-line-no">137</span><span id="line-137">            }</span>
<span class="source-line-no">138</span><span id="line-138">        });</span>
<span class="source-line-no">139</span><span id="line-139">    }</span>
<span class="source-line-no">140</span><span id="line-140"></span>
<span class="source-line-no">141</span><span id="line-141">    private void loadApplicationInstancesForV1() {</span>
<span class="source-line-no">142</span><span id="line-142">        ApplicationInstance applicationInstance = dataRepository.getApplicationInstance();</span>
<span class="source-line-no">143</span><span id="line-143">        if (applicationInstance != null) {</span>
<span class="source-line-no">144</span><span id="line-144">            setApplicationInstanceFor(PingOneRegion.NA, applicationInstance);</span>
<span class="source-line-no">145</span><span id="line-145">            dataRepository.saveApplicationInstance(PingOneRegion.NA, applicationInstance);</span>
<span class="source-line-no">146</span><span id="line-146">        }</span>
<span class="source-line-no">147</span><span id="line-147">    }</span>
<span class="source-line-no">148</span><span id="line-148"></span>
<span class="source-line-no">149</span><span id="line-149">    private NetworkManager getNetworkManagerFor(String applicationInstanceId) {</span>
<span class="source-line-no">150</span><span id="line-150">        ApplicationInstance applicationInstance = applicationInstances.get(applicationInstanceId);</span>
<span class="source-line-no">151</span><span id="line-151">        if (applicationInstance == null) {</span>
<span class="source-line-no">152</span><span id="line-152">            return null;</span>
<span class="source-line-no">153</span><span id="line-153">        }</span>
<span class="source-line-no">154</span><span id="line-154">        return getNetworkManagerFor(applicationInstance);</span>
<span class="source-line-no">155</span><span id="line-155">    }</span>
<span class="source-line-no">156</span><span id="line-156"></span>
<span class="source-line-no">157</span><span id="line-157">    private NetworkManager getNetworkManagerFor(PingOneRegion region) {</span>
<span class="source-line-no">158</span><span id="line-158">        ApplicationInstance applicationInstance = getApplicationInstance(region);</span>
<span class="source-line-no">159</span><span id="line-159">        if (applicationInstance == null) {</span>
<span class="source-line-no">160</span><span id="line-160">            return null;</span>
<span class="source-line-no">161</span><span id="line-161">        }</span>
<span class="source-line-no">162</span><span id="line-162"></span>
<span class="source-line-no">163</span><span id="line-163">        return getNetworkManagerFor(applicationInstance);</span>
<span class="source-line-no">164</span><span id="line-164">    }</span>
<span class="source-line-no">165</span><span id="line-165"></span>
<span class="source-line-no">166</span><span id="line-166">    private NetworkManager getNetworkManagerFor(ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">167</span><span id="line-167">        NetworkManager networkManager = networkManagers.get(applicationInstance.getId().toString());</span>
<span class="source-line-no">168</span><span id="line-168">        if (networkManager != null) {</span>
<span class="source-line-no">169</span><span id="line-169">            return networkManager;</span>
<span class="source-line-no">170</span><span id="line-170">        } else if (getRegionForApplicationInstance(applicationInstance) != null) {</span>
<span class="source-line-no">171</span><span id="line-171">            return getNetworkManagerFor(getRegionForApplicationInstance(applicationInstance), applicationInstance);</span>
<span class="source-line-no">172</span><span id="line-172">        } else {</span>
<span class="source-line-no">173</span><span id="line-173">            return null;</span>
<span class="source-line-no">174</span><span id="line-174">        }</span>
<span class="source-line-no">175</span><span id="line-175">    }</span>
<span class="source-line-no">176</span><span id="line-176"></span>
<span class="source-line-no">177</span><span id="line-177">    private NetworkManager getNetworkManagerFor(PingOneRegion walletRegion, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">178</span><span id="line-178">        NetworkManager networkManager = networkManagers.get(applicationInstance.getId().toString());</span>
<span class="source-line-no">179</span><span id="line-179">        if (networkManager != null) {</span>
<span class="source-line-no">180</span><span id="line-180">            return networkManager;</span>
<span class="source-line-no">181</span><span id="line-181">        } else {</span>
<span class="source-line-no">182</span><span id="line-182">            applicationInstances.put(applicationInstance.getId().toString(), applicationInstance);</span>
<span class="source-line-no">183</span><span id="line-183">            return initNetworkManagerFor(walletRegion, applicationInstance);</span>
<span class="source-line-no">184</span><span id="line-184">        }</span>
<span class="source-line-no">185</span><span id="line-185">    }</span>
<span class="source-line-no">186</span><span id="line-186"></span>
<span class="source-line-no">187</span><span id="line-187">    private NetworkManager initNetworkManagerFor(PingOneRegion walletRegion, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">188</span><span id="line-188">        DidMessageHandler didMessageHandler = new DidMessageHandler(applicationInstance, walletRegion, this);</span>
<span class="source-line-no">189</span><span id="line-189">        NetworkManager networkManager = new NetworkManager(walletRegion, applicationInstance, didMessageHandler, didMessageHandler);</span>
<span class="source-line-no">190</span><span id="line-190">        networkManagers.put(applicationInstance.getId().toString(), networkManager);</span>
<span class="source-line-no">191</span><span id="line-191">        return networkManager;</span>
<span class="source-line-no">192</span><span id="line-192">    }</span>
<span class="source-line-no">193</span><span id="line-193"></span>
<span class="source-line-no">194</span><span id="line-194"></span>
<span class="source-line-no">195</span><span id="line-195">    public static void setApplicationInstanceFor(PingOneRegion walletRegion, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">196</span><span id="line-196">        applicationInstances.put(applicationInstance.getId().toString(), applicationInstance);</span>
<span class="source-line-no">197</span><span id="line-197">        applicationInstanceIdByRegions.put(applicationInstance.getId().toString(), walletRegion);</span>
<span class="source-line-no">198</span><span id="line-198">    }</span>
<span class="source-line-no">199</span><span id="line-199"></span>
<span class="source-line-no">200</span><span id="line-200">    /**</span>
<span class="source-line-no">201</span><span id="line-201">     * Call this method to register the optional storage manager that can be used by the SDK to maintain the values for claims and other data.</span>
<span class="source-line-no">202</span><span id="line-202">     * @param storageManager Implementation of StorageManagerContract interface</span>
<span class="source-line-no">203</span><span id="line-203">     * @see StorageManagerContract</span>
<span class="source-line-no">204</span><span id="line-204">     */</span>
<span class="source-line-no">205</span><span id="line-205">    @Override</span>
<span class="source-line-no">206</span><span id="line-206">    public void registerStorageManager(@NonNull StorageManagerContract storageManager) {</span>
<span class="source-line-no">207</span><span id="line-207">        this.storageManager = storageManager;</span>
<span class="source-line-no">208</span><span id="line-208">        dataRepository = new DataRepositoryImpl(storageManager);</span>
<span class="source-line-no">209</span><span id="line-209">    }</span>
<span class="source-line-no">210</span><span id="line-210"></span>
<span class="source-line-no">211</span><span id="line-211">    /**</span>
<span class="source-line-no">212</span><span id="line-212">     * Call this method to get the StorageManagerContract that is used by the SDK to store credentials and other information.</span>
<span class="source-line-no">213</span><span id="line-213">     * @return Registered instance of StorageManagerContract interface implementation</span>
<span class="source-line-no">214</span><span id="line-214">     */</span>
<span class="source-line-no">215</span><span id="line-215">    @Override</span>
<span class="source-line-no">216</span><span id="line-216">    public StorageManagerContract getStorageManager() {</span>
<span class="source-line-no">217</span><span id="line-217">        return storageManager;</span>
<span class="source-line-no">218</span><span id="line-218">    }</span>
<span class="source-line-no">219</span><span id="line-219"></span>
<span class="source-line-no">220</span><span id="line-220">    /**</span>
<span class="source-line-no">221</span><span id="line-221">     * Call this method to get the DataRepository that is used by the SDK to store credentials and other information.</span>
<span class="source-line-no">222</span><span id="line-222">     * @return An instance of DataRepository using the registered StorageManagerContract</span>
<span class="source-line-no">223</span><span id="line-223">     */</span>
<span class="source-line-no">224</span><span id="line-224">    @Override</span>
<span class="source-line-no">225</span><span id="line-225">    public DataRepository getDataRepository() {</span>
<span class="source-line-no">226</span><span id="line-226">        return dataRepository;</span>
<span class="source-line-no">227</span><span id="line-227">    }</span>
<span class="source-line-no">228</span><span id="line-228"></span>
<span class="source-line-no">229</span><span id="line-229">    /**</span>
<span class="source-line-no">230</span><span id="line-230">     * Call this method to register a callback handler to listen for wallet actions</span>
<span class="source-line-no">231</span><span id="line-231">     * @param callbackHandler Instance of WalletCallbackHandler to handle important events such as credential issuance/revocation etc.</span>
<span class="source-line-no">232</span><span id="line-232">     */</span>
<span class="source-line-no">233</span><span id="line-233">    @Override</span>
<span class="source-line-no">234</span><span id="line-234">    public void registerCallbackHandler(@NonNull WalletCallbackHandler callbackHandler) {</span>
<span class="source-line-no">235</span><span id="line-235">        this.walletCallbackHandler = callbackHandler;</span>
<span class="source-line-no">236</span><span id="line-236">    }</span>
<span class="source-line-no">237</span><span id="line-237"></span>
<span class="source-line-no">238</span><span id="line-238">    /**</span>
<span class="source-line-no">239</span><span id="line-239">     * Returns ApplicationInstance used to register the wallet in PingOneRegion</span>
<span class="source-line-no">240</span><span id="line-240">     * @param walletRegion: PingOneRegion</span>
<span class="source-line-no">241</span><span id="line-241">     * @return ApplicationInstance containing keys and ID for the SDK instance for the PingOneRegion</span>
<span class="source-line-no">242</span><span id="line-242">     */</span>
<span class="source-line-no">243</span><span id="line-243">    public ApplicationInstance getApplicationInstance(PingOneRegion walletRegion) {</span>
<span class="source-line-no">244</span><span id="line-244">        Optional&lt;Map.Entry&lt;String, PingOneRegion&gt;&gt; data = applicationInstanceIdByRegions.entrySet().stream()</span>
<span class="source-line-no">245</span><span id="line-245">                .filter(entry -&gt; entry.getValue().equals(walletRegion) &amp;&amp; entry.getKey() != null)</span>
<span class="source-line-no">246</span><span id="line-246">                .findFirst();</span>
<span class="source-line-no">247</span><span id="line-247">        return data.map(stringPingOneRegionEntry -&gt;</span>
<span class="source-line-no">248</span><span id="line-248">                applicationInstances.get(stringPingOneRegionEntry.getKey())).orElse(null);</span>
<span class="source-line-no">249</span><span id="line-249">    }</span>
<span class="source-line-no">250</span><span id="line-250"></span>
<span class="source-line-no">251</span><span id="line-251">    public PingOneRegion getRegionForApplicationInstance(ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">252</span><span id="line-252">        return applicationInstanceIdByRegions.get(applicationInstance.getId().toString());</span>
<span class="source-line-no">253</span><span id="line-253">    }</span>
<span class="source-line-no">254</span><span id="line-254"></span>
<span class="source-line-no">255</span><span id="line-255">    /**</span>
<span class="source-line-no">256</span><span id="line-256">     * Call this function to pair your wallet app for future issuance and receive credential updates</span>
<span class="source-line-no">257</span><span id="line-257">     * @param pairingRequest: PairingRequest from service for wallet pairing containing the issuer ID and optional challenge required for pairing</span>
<span class="source-line-no">258</span><span id="line-258">     * @param pushToken: Optional push token</span>
<span class="source-line-no">259</span><span id="line-259">     * @return Returns the ApplicationInstance registered for pairing</span>
<span class="source-line-no">260</span><span id="line-260">     * @throws WalletException if pairing is unsuccessful</span>
<span class="source-line-no">261</span><span id="line-261">     */</span>
<span class="source-line-no">262</span><span id="line-262">    @Override</span>
<span class="source-line-no">263</span><span id="line-263">    public ApplicationInstance pairWallet(@NonNull PairingRequest pairingRequest, @Nullable String pushToken) throws WalletException {</span>
<span class="source-line-no">264</span><span id="line-264">        return null;</span>
<span class="source-line-no">265</span><span id="line-265">    }</span>
<span class="source-line-no">266</span><span id="line-266"></span>
<span class="source-line-no">267</span><span id="line-267">    /**</span>
<span class="source-line-no">268</span><span id="line-268">     * Call this function to pair your wallet app for future issuance and receive credential updates</span>
<span class="source-line-no">269</span><span id="line-269">     * @param presentationRequest: Request from service for wallet pairing containing the issuer ID and session id required for pairing</span>
<span class="source-line-no">270</span><span id="line-270">     * @param pushToken: Optional push token</span>
<span class="source-line-no">271</span><span id="line-271">     * @return Returns the ApplicationInstance registered for pairing</span>
<span class="source-line-no">272</span><span id="line-272">     * @throws WalletException if pairing is unsuccessful</span>
<span class="source-line-no">273</span><span id="line-273">     */</span>
<span class="source-line-no">274</span><span id="line-274">    @SuppressLint("CheckResult")</span>
<span class="source-line-no">275</span><span id="line-275">    @Override</span>
<span class="source-line-no">276</span><span id="line-276">    public ApplicationInstance pairWallet(@NonNull PresentationRequest presentationRequest, @Nullable String pushToken) throws WalletException {</span>
<span class="source-line-no">277</span><span id="line-277">        ApplicationInstance applicationInstance = applicationInstances.get(presentationRequest.getApplicationInstanceId());</span>
<span class="source-line-no">278</span><span id="line-278">        if (applicationInstance == null) {</span>
<span class="source-line-no">279</span><span id="line-279">            throw new WalletException("Must register the required application instance used in the wallet pairing request");</span>
<span class="source-line-no">280</span><span id="line-280">        }</span>
<span class="source-line-no">281</span><span id="line-281"></span>
<span class="source-line-no">282</span><span id="line-282">        NetworkManager networkManager = getNetworkManagerFor(applicationInstance);</span>
<span class="source-line-no">283</span><span id="line-283">        if (networkManager == null) {</span>
<span class="source-line-no">284</span><span id="line-284">            throw new WalletException("Must register the required application instance used in the wallet pairing request");</span>
<span class="source-line-no">285</span><span id="line-285">        }</span>
<span class="source-line-no">286</span><span id="line-286"></span>
<span class="source-line-no">287</span><span id="line-287">        final String pnToken = Optional.ofNullable(pushToken).orElse(applicationInstance.getPushToken());</span>
<span class="source-line-no">288</span><span id="line-288">        if (pnToken != null) {</span>
<span class="source-line-no">289</span><span id="line-289">            this.updatePushToken(pnToken);</span>
<span class="source-line-no">290</span><span id="line-290">        }</span>
<span class="source-line-no">291</span><span id="line-291"></span>
<span class="source-line-no">292</span><span id="line-292">        if (presentationRequest.getRequestor() == null || presentationRequest.getSessionId() == null) {</span>
<span class="source-line-no">293</span><span id="line-293">            throw new WalletException("Missing required information from request, cannot pair wallet");</span>
<span class="source-line-no">294</span><span id="line-294">        }</span>
<span class="source-line-no">295</span><span id="line-295"></span>
<span class="source-line-no">296</span><span id="line-296">        final String messagePayload = JsonUtil.simple()</span>
<span class="source-line-no">297</span><span id="line-297">                .adapter(PairingPayload.class)</span>
<span class="source-line-no">298</span><span id="line-298">                .toJson(new PairingPayload(new WalletMetadata(appPackage, pushToken)));</span>
<span class="source-line-no">299</span><span id="line-299"></span>
<span class="source-line-no">300</span><span id="line-300">        final Challenge challenge = new Challenge();</span>
<span class="source-line-no">301</span><span id="line-301">        challenge.setId(presentationRequest.getSessionId());</span>
<span class="source-line-no">302</span><span id="line-302"></span>
<span class="source-line-no">303</span><span id="line-303">        networkManager.sendSecureMessage(presentationRequest.getRequestor(), messagePayload, challenge)</span>
<span class="source-line-no">304</span><span id="line-304">                .subscribeOn(Schedulers.io())</span>
<span class="source-line-no">305</span><span id="line-305">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="source-line-no">306</span><span id="line-306">                .subscribe(</span>
<span class="source-line-no">307</span><span id="line-307">                        () -&gt; Log.i(TAG, "Secure message sent."),</span>
<span class="source-line-no">308</span><span id="line-308">                        throwable -&gt; {</span>
<span class="source-line-no">309</span><span id="line-309">                            Log.e(TAG, "Failed to send secure message: ", throwable);</span>
<span class="source-line-no">310</span><span id="line-310">                            throw throwable;</span>
<span class="source-line-no">311</span><span id="line-311">                        }</span>
<span class="source-line-no">312</span><span id="line-312">                );</span>
<span class="source-line-no">313</span><span id="line-313">        return applicationInstance;</span>
<span class="source-line-no">314</span><span id="line-314">    }</span>
<span class="source-line-no">315</span><span id="line-315"></span>
<span class="source-line-no">316</span><span id="line-316">    //This method is deprecated and will be removed in upcoming updates.</span>
<span class="source-line-no">317</span><span id="line-317">    @Override</span>
<span class="source-line-no">318</span><span id="line-318">    public ApplicationInstance updatePushToken(@NonNull final String pushToken) {</span>
<span class="source-line-no">319</span><span id="line-319">        return updatePushTokens(pushToken).get(0);</span>
<span class="source-line-no">320</span><span id="line-320">    }</span>
<span class="source-line-no">321</span><span id="line-321"></span>
<span class="source-line-no">322</span><span id="line-322">    /**</span>
<span class="source-line-no">323</span><span id="line-323">     * Update Firebase token to receive notification from the service</span>
<span class="source-line-no">324</span><span id="line-324">     * @param pushToken Firebase Push Token</span>
<span class="source-line-no">325</span><span id="line-325">     * @return Updated ApplicationInstance objects</span>
<span class="source-line-no">326</span><span id="line-326">     */</span>
<span class="source-line-no">327</span><span id="line-327">    @Override</span>
<span class="source-line-no">328</span><span id="line-328">    public List&lt;ApplicationInstance&gt; updatePushTokens(String pushToken) {</span>
<span class="source-line-no">329</span><span id="line-329">        List&lt;ApplicationInstance&gt; instancesWithToken = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">330</span><span id="line-330">        applicationInstances.values().forEach(applicationInstance -&gt; {</span>
<span class="source-line-no">331</span><span id="line-331">            applicationInstance.setPushToken(pushToken);</span>
<span class="source-line-no">332</span><span id="line-332">            applicationInstance.setPushSandbox(BuildConfig.DEBUG);</span>
<span class="source-line-no">333</span><span id="line-333">            PingOneRegion walletRegion = applicationInstanceIdByRegions.get(applicationInstance.getId().toString());</span>
<span class="source-line-no">334</span><span id="line-334">            if (walletRegion != null) {</span>
<span class="source-line-no">335</span><span id="line-335">                dataRepository.saveApplicationInstance(walletRegion, applicationInstance);</span>
<span class="source-line-no">336</span><span id="line-336">                instancesWithToken.add(applicationInstance);</span>
<span class="source-line-no">337</span><span id="line-337">            }</span>
<span class="source-line-no">338</span><span id="line-338">        });</span>
<span class="source-line-no">339</span><span id="line-339">        return instancesWithToken;</span>
<span class="source-line-no">340</span><span id="line-340">    }</span>
<span class="source-line-no">341</span><span id="line-341"></span>
<span class="source-line-no">342</span><span id="line-342">    /**</span>
<span class="source-line-no">343</span><span id="line-343">     * Handle URL for issuance or presentation</span>
<span class="source-line-no">344</span><span id="line-344">     * @param qrContent Raw content from the QR code</span>
<span class="source-line-no">345</span><span id="line-345">     *</span>
<span class="source-line-no">346</span><span id="line-346">     * This method is deprecated and will be removed in upcoming updates. Use processPingOneRequest instead</span>
<span class="source-line-no">347</span><span id="line-347">     */</span>
<span class="source-line-no">348</span><span id="line-348">    @Override</span>
<span class="source-line-no">349</span><span id="line-349">    public void processQrContent(@NonNull final String qrContent) {</span>
<span class="source-line-no">350</span><span id="line-350">        processPingOneRequest(qrContent);</span>
<span class="source-line-no">351</span><span id="line-351">    }</span>
<span class="source-line-no">352</span><span id="line-352"></span>
<span class="source-line-no">353</span><span id="line-353">    /**</span>
<span class="source-line-no">354</span><span id="line-354">     * Forward content from QR codes and universal links for processing. Make sure to register the callbackhandler beforehand to receive the result.</span>
<span class="source-line-no">355</span><span id="line-355">     * @param qrContent: Raw content from the QR code</span>
<span class="source-line-no">356</span><span id="line-356">     */</span>
<span class="source-line-no">357</span><span id="line-357">    @Override</span>
<span class="source-line-no">358</span><span id="line-358">    public void processPingOneRequest(@NonNull final String qrContent) {</span>
<span class="source-line-no">359</span><span id="line-359">        try {</span>
<span class="source-line-no">360</span><span id="line-360">            if (OpenIDVerifiableCredentialsClient.isValidOpenIdVcUrl(qrContent)) {</span>
<span class="source-line-no">361</span><span id="line-361">                openIDVerifiableCredentialsClient.processUrl(qrContent);</span>
<span class="source-line-no">362</span><span id="line-362">                return;</span>
<span class="source-line-no">363</span><span id="line-363">            }</span>
<span class="source-line-no">364</span><span id="line-364">        } catch (InvalidUrlException e) {</span>
<span class="source-line-no">365</span><span id="line-365">            return;</span>
<span class="source-line-no">366</span><span id="line-366">        }</span>
<span class="source-line-no">367</span><span id="line-367">        PingOneRegion region = PingOneRegion.initForUrl(qrContent);</span>
<span class="source-line-no">368</span><span id="line-368">        processPingOneRequest(region, qrContent);</span>
<span class="source-line-no">369</span><span id="line-369">    }</span>
<span class="source-line-no">370</span><span id="line-370"></span>
<span class="source-line-no">371</span><span id="line-371">    public void processPingOneRequest(PingOneRegion region, @NonNull final String request) {</span>
<span class="source-line-no">372</span><span id="line-372">        NetworkManager networkManager = getNetworkManagerFor(region);</span>
<span class="source-line-no">373</span><span id="line-373">        if (networkManager != null) {</span>
<span class="source-line-no">374</span><span id="line-374">            processUrl(networkManager, request);</span>
<span class="source-line-no">375</span><span id="line-375">        } else if (!allowOtherRegions) {</span>
<span class="source-line-no">376</span><span id="line-376">            handleWalletError(new WalletException(String.format("Client is not allowed to initialize application instance for %s region", region.toString())));</span>
<span class="source-line-no">377</span><span id="line-377">        } else {</span>
<span class="source-line-no">378</span><span id="line-378">            JsonWebKeySet clientJwks = null;</span>
<span class="source-line-no">379</span><span id="line-379">            String pushToken = null;</span>
<span class="source-line-no">380</span><span id="line-380">            Optional&lt;ApplicationInstance&gt; appInstance = applicationInstances.values().stream().findFirst();</span>
<span class="source-line-no">381</span><span id="line-381">            if (appInstance.isPresent()) {</span>
<span class="source-line-no">382</span><span id="line-382">                clientJwks = appInstance.get().getJwks();</span>
<span class="source-line-no">383</span><span id="line-383">                pushToken = appInstance.get().getPushToken();</span>
<span class="source-line-no">384</span><span id="line-384">            }</span>
<span class="source-line-no">385</span><span id="line-385">            registerNewApplicationInstance(region, clientJwks, pushToken).subscribe(applicationInstance -&gt; {</span>
<span class="source-line-no">386</span><span id="line-386">                setApplicationInstanceFor(region, applicationInstance);</span>
<span class="source-line-no">387</span><span id="line-387">                dataRepository.saveApplicationInstance(region, applicationInstance);</span>
<span class="source-line-no">388</span><span id="line-388">                processPingOneRequest(region, request);</span>
<span class="source-line-no">389</span><span id="line-389">            });</span>
<span class="source-line-no">390</span><span id="line-390"></span>
<span class="source-line-no">391</span><span id="line-391">        }</span>
<span class="source-line-no">392</span><span id="line-392">    }</span>
<span class="source-line-no">393</span><span id="line-393"></span>
<span class="source-line-no">394</span><span id="line-394">    private void processUrl(NetworkManager networkManager, String request) {</span>
<span class="source-line-no">395</span><span id="line-395">        networkManager.processUrl(request, exception -&gt; {</span>
<span class="source-line-no">396</span><span id="line-396">            if (exception instanceof InvalidUrlException) {</span>
<span class="source-line-no">397</span><span id="line-397">                Log.e(TAG, "Cannot process QR Content: Invalid URL.", exception);</span>
<span class="source-line-no">398</span><span id="line-398">                Log.i(TAG, "Trying to process qrContent as ShareRequest");</span>
<span class="source-line-no">399</span><span id="line-399">                try {</span>
<span class="source-line-no">400</span><span id="line-400">                    handleJsonInQr(request, networkManager.getApplicationInstance());</span>
<span class="source-line-no">401</span><span id="line-401">                } catch (Exception ex) {</span>
<span class="source-line-no">402</span><span id="line-402">                    Log.e(TAG, "Failed to process QR Content as JSON.", ex);</span>
<span class="source-line-no">403</span><span id="line-403">                }</span>
<span class="source-line-no">404</span><span id="line-404">            }</span>
<span class="source-line-no">405</span><span id="line-405"></span>
<span class="source-line-no">406</span><span id="line-406">            if (exception instanceof NotFoundException) {</span>
<span class="source-line-no">407</span><span id="line-407">                this.handleWalletError(new WalletException("Cannot parse request", exception));</span>
<span class="source-line-no">408</span><span id="line-408">                Log.e(TAG, "Cannot process QR Content: Could not retrieve request.", exception);</span>
<span class="source-line-no">409</span><span id="line-409">            }</span>
<span class="source-line-no">410</span><span id="line-410">        });</span>
<span class="source-line-no">411</span><span id="line-411">    }</span>
<span class="source-line-no">412</span><span id="line-412"></span>
<span class="source-line-no">413</span><span id="line-413">    /**</span>
<span class="source-line-no">414</span><span id="line-414">     *Forward content from push notifications payload for processing. Make sure to register the callbackhandler beforehand to receive the result.</span>
<span class="source-line-no">415</span><span id="line-415">     * @param userInfo: Push notification payload</span>
<span class="source-line-no">416</span><span id="line-416">     * @return true if the notification can be handled by Wallet SDK and false if the SDK cannot recognize it as a PingOne notification</span>
<span class="source-line-no">417</span><span id="line-417">     */</span>
<span class="source-line-no">418</span><span id="line-418">    @Override</span>
<span class="source-line-no">419</span><span id="line-419">    public boolean processNotification(Map&lt;Object, Object&gt; userInfo) {</span>
<span class="source-line-no">420</span><span id="line-420">        String base64encodedMap = (String) userInfo.get("PingOne");</span>
<span class="source-line-no">421</span><span id="line-421">        if (base64encodedMap != null) {</span>
<span class="source-line-no">422</span><span id="line-422">            return handleNotificationUserInfo(base64encodedMap);</span>
<span class="source-line-no">423</span><span id="line-423">        } else {</span>
<span class="source-line-no">424</span><span id="line-424">            return false;</span>
<span class="source-line-no">425</span><span id="line-425">        }</span>
<span class="source-line-no">426</span><span id="line-426">    }</span>
<span class="source-line-no">427</span><span id="line-427"></span>
<span class="source-line-no">428</span><span id="line-428">    private boolean handleNotificationUserInfo(String base64EncodedMap) {</span>
<span class="source-line-no">429</span><span id="line-429">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O &amp;&amp;</span>
<span class="source-line-no">430</span><span id="line-430">                (Base64.getDecoder().decode(base64EncodedMap) != null)) {</span>
<span class="source-line-no">431</span><span id="line-431">            checkForMessages();</span>
<span class="source-line-no">432</span><span id="line-432">            return true;</span>
<span class="source-line-no">433</span><span id="line-433">        }</span>
<span class="source-line-no">434</span><span id="line-434">        return false;</span>
<span class="source-line-no">435</span><span id="line-435">    }</span>
<span class="source-line-no">436</span><span id="line-436"></span>
<span class="source-line-no">437</span><span id="line-437">    /** Helper method to start polling for new messages sent to the wallet. Use this method only if you are not using push notifications. */</span>
<span class="source-line-no">438</span><span id="line-438">    public void pollForMessages() {</span>
<span class="source-line-no">439</span><span id="line-439">        PollingHelper.getInstance().startPolling(this::checkForMessages);</span>
<span class="source-line-no">440</span><span id="line-440">    }</span>
<span class="source-line-no">441</span><span id="line-441"></span>
<span class="source-line-no">442</span><span id="line-442">    /** Call this method to stop polling for messages sent to the wallet */</span>
<span class="source-line-no">443</span><span id="line-443">    public void stopPolling() {</span>
<span class="source-line-no">444</span><span id="line-444">        PollingHelper.getInstance().stopPolling();</span>
<span class="source-line-no">445</span><span id="line-445">    }</span>
<span class="source-line-no">446</span><span id="line-446"></span>
<span class="source-line-no">447</span><span id="line-447">    /** Call this method to check if wallet has received any new messages in the mailbox. This method can be used to check for messages on user action or if push notifications are not available. */</span>
<span class="source-line-no">448</span><span id="line-448">    @Override</span>
<span class="source-line-no">449</span><span id="line-449">    public void checkForMessages() {</span>
<span class="source-line-no">450</span><span id="line-450">        networkManagers.values().forEach(NetworkManager::processMessages);</span>
<span class="source-line-no">451</span><span id="line-451">    }</span>
<span class="source-line-no">452</span><span id="line-452"></span>
<span class="source-line-no">453</span><span id="line-453">    @SuppressWarnings("unchecked")</span>
<span class="source-line-no">454</span><span id="line-454">    private void handleJsonInQr(@NonNull final String qrContent, ApplicationInstance applicationInstance) throws Exception {</span>
<span class="source-line-no">455</span><span id="line-455">        final Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) JsonUtil.simple().adapter(new TypeToken&lt;Map&lt;String, Object&gt;&gt;() {</span>
<span class="source-line-no">456</span><span id="line-456">        }.getType()).fromJson(qrContent);</span>
<span class="source-line-no">457</span><span id="line-457">        if (map == null) {</span>
<span class="source-line-no">458</span><span id="line-458">            Log.e(TAG, "Failed to process QR Content as JSON.");</span>
<span class="source-line-no">459</span><span id="line-459">        } else {</span>
<span class="source-line-no">460</span><span id="line-460">            final CredentialRequest request = new CredentialRequest(map);</span>
<span class="source-line-no">461</span><span id="line-461">            if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">462</span><span id="line-462">                this.walletCallbackHandler.handleCredentialRequest(new PresentationRequest(applicationInstance.getId().toString(), request, null));</span>
<span class="source-line-no">463</span><span id="line-463">            }</span>
<span class="source-line-no">464</span><span id="line-464">        }</span>
<span class="source-line-no">465</span><span id="line-465">    }</span>
<span class="source-line-no">466</span><span id="line-466"></span>
<span class="source-line-no">467</span><span id="line-467">    /**</span>
<span class="source-line-no">468</span><span id="line-468">     * Call this method to filter the verifiable credentials that match the schema defined in the input descriptor in the presentation request.</span>
<span class="source-line-no">469</span><span id="line-469">     * @param request PresentationRequest containing the filtering criteria and other metadata</span>
<span class="source-line-no">470</span><span id="line-470">     * @param credentials List of claims saved in the Wallet</span>
<span class="source-line-no">471</span><span id="line-471">     * @return PresentationMatherResult containing the list of credentials matching the criteria defined in the presentation request</span>
<span class="source-line-no">472</span><span id="line-472">     */</span>
<span class="source-line-no">473</span><span id="line-473">    @Override</span>
<span class="source-line-no">474</span><span id="line-474">    public PresentationMatcherResult findMatchingCredentialsForRequest(@NonNull final PresentationRequest request, @NonNull final List&lt;Claim&gt; credentials) {</span>
<span class="source-line-no">475</span><span id="line-475">        if (request.getCredentialRequest() != null) {</span>
<span class="source-line-no">476</span><span id="line-476">            final List&lt;CredentialMatcherResult&gt; result = findMatchingClaimsForRequest(request.getCredentialRequest(), credentials);</span>
<span class="source-line-no">477</span><span id="line-477">            return new PresentationMatcherResult(result, null, null);</span>
<span class="source-line-no">478</span><span id="line-478">        }</span>
<span class="source-line-no">479</span><span id="line-479"></span>
<span class="source-line-no">480</span><span id="line-480">        if (request.getVerifiablePresentationRequest() != null) {</span>
<span class="source-line-no">481</span><span id="line-481">            List&lt;VerifiableCredential&gt; verifiableCredentials = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">482</span><span id="line-482">            Map&lt;String, Claim&gt; credentialClaims = new HashMap&lt;&gt;();</span>
<span class="source-line-no">483</span><span id="line-483"></span>
<span class="source-line-no">484</span><span id="line-484">            for (Claim credential : credentials) {</span>
<span class="source-line-no">485</span><span id="line-485">                final List&lt;VerifiableCredential&gt; foundCredentials = ClaimPresentationHelper.getVerifiableCredentialsFromClaim(credential);</span>
<span class="source-line-no">486</span><span id="line-486">                if (foundCredentials.isEmpty()) {</span>
<span class="source-line-no">487</span><span id="line-487">                    continue;</span>
<span class="source-line-no">488</span><span id="line-488">                }</span>
<span class="source-line-no">489</span><span id="line-489">                foundCredentials.forEach(vc -&gt; credentialClaims.put(vc.getCredential().getId(), credential));</span>
<span class="source-line-no">490</span><span id="line-490">                verifiableCredentials.addAll(foundCredentials);</span>
<span class="source-line-no">491</span><span id="line-491">            }</span>
<span class="source-line-no">492</span><span id="line-492"></span>
<span class="source-line-no">493</span><span id="line-493">            final VerifiablePresentationMatcherResult result = findMatchingVerifiableCredentialsForRequest(request.getVerifiablePresentationRequest(), verifiableCredentials);</span>
<span class="source-line-no">494</span><span id="line-494">            return new PresentationMatcherResult(null, result, credentialClaims);</span>
<span class="source-line-no">495</span><span id="line-495">        }</span>
<span class="source-line-no">496</span><span id="line-496"></span>
<span class="source-line-no">497</span><span id="line-497">        return new PresentationMatcherResult(null, null, null);</span>
<span class="source-line-no">498</span><span id="line-498">    }</span>
<span class="source-line-no">499</span><span id="line-499"></span>
<span class="source-line-no">500</span><span id="line-500">    /**</span>
<span class="source-line-no">501</span><span id="line-501">     * Call this method to share the presentation with the requester</span>
<span class="source-line-no">502</span><span id="line-502">     * @param presentation CredentialPresentation object containing filtered credentials and presentation request</span>
<span class="source-line-no">503</span><span id="line-503">     * @return PresentationResult returned after credential presentation</span>
<span class="source-line-no">504</span><span id="line-504">     */</span>
<span class="source-line-no">505</span><span id="line-505">    public Single&lt;PresentationResult&gt; presentCredentials(@NonNull final CredentialsPresentation presentation) {</span>
<span class="source-line-no">506</span><span id="line-506">        ApplicationInstance applicationInstance = applicationInstances.get(presentation.getPresentationRequest().getApplicationInstanceId());</span>
<span class="source-line-no">507</span><span id="line-507">        if (applicationInstance == null) {</span>
<span class="source-line-no">508</span><span id="line-508">            return getCredentialsPresentation("Invalid application instance used in the request - " + presentation.getApplicationInstanceId());</span>
<span class="source-line-no">509</span><span id="line-509">        }</span>
<span class="source-line-no">510</span><span id="line-510"></span>
<span class="source-line-no">511</span><span id="line-511">        CredentialRequest credentialRequest = presentation.getPresentationRequest().getCredentialRequest();</span>
<span class="source-line-no">512</span><span id="line-512">        if (credentialRequest != null) {</span>
<span class="source-line-no">513</span><span id="line-513">            return shareRequestedCredentials(presentation, credentialRequest);</span>
<span class="source-line-no">514</span><span id="line-514">        } else if (presentation.getPresentationRequest().getVerifiablePresentationRequest() != null) {</span>
<span class="source-line-no">515</span><span id="line-515">            return sendVerifiablePresentation(presentation, applicationInstance);</span>
<span class="source-line-no">516</span><span id="line-516">        } else {</span>
<span class="source-line-no">517</span><span id="line-517">            return getCredentialsPresentation(null);</span>
<span class="source-line-no">518</span><span id="line-518">        }</span>
<span class="source-line-no">519</span><span id="line-519">    }</span>
<span class="source-line-no">520</span><span id="line-520"></span>
<span class="source-line-no">521</span><span id="line-521">    private Single&lt;PresentationResult&gt; shareRequestedCredentials(CredentialsPresentation presentation, CredentialRequest credentialRequest) {</span>
<span class="source-line-no">522</span><span id="line-522">        List&lt;Share&gt; claimShares = presentation.getShares();</span>
<span class="source-line-no">523</span><span id="line-523">        NetworkManager networkManager = getNetworkManagerFor(presentation.getPresentationRequest().getApplicationInstanceId());</span>
<span class="source-line-no">524</span><span id="line-524">        if (networkManager == null || claimShares == null) {</span>
<span class="source-line-no">525</span><span id="line-525">            return getCredentialsPresentation("Must register the required application instance used in the request - " + presentation.getApplicationInstanceId());</span>
<span class="source-line-no">526</span><span id="line-526">        }</span>
<span class="source-line-no">527</span><span id="line-527">        return networkManager.shareData(credentialRequest, claimShares)</span>
<span class="source-line-no">528</span><span id="line-528">                .toSingleDefault(new PresentationResult(true, null, null))</span>
<span class="source-line-no">529</span><span id="line-529">                .onErrorReturn(throwable -&gt; new PresentationResult(false, null, throwable));</span>
<span class="source-line-no">530</span><span id="line-530">    }</span>
<span class="source-line-no">531</span><span id="line-531"></span>
<span class="source-line-no">532</span><span id="line-532">    private Single&lt;PresentationResult&gt; sendVerifiablePresentation(CredentialsPresentation presentation, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">533</span><span id="line-533">        VerifiablePresentationRequest verifiablePresentationRequest = presentation.getPresentationRequest().getVerifiablePresentationRequest();</span>
<span class="source-line-no">534</span><span id="line-534">        Map&lt;InputDescriptor, VerifiableCredential&gt; verifiablePresentation = presentation.getVerifiablePresentation();</span>
<span class="source-line-no">535</span><span id="line-535">        try {</span>
<span class="source-line-no">536</span><span id="line-536">            DID did = DidSupport.INSTANCE.createDID(applicationInstance.getId(), applicationInstance.getJwks());</span>
<span class="source-line-no">537</span><span id="line-537">            VerifiablePresentationResult result = openIDVerifiableCredentialsClient.sendVerifiablePresentation(did, verifiablePresentationRequest, verifiablePresentation);</span>
<span class="source-line-no">538</span><span id="line-538">            return Single.fromCallable(() -&gt; new PresentationResult(result != null, null, null));</span>
<span class="source-line-no">539</span><span id="line-539">        } catch (Exception e) {</span>
<span class="source-line-no">540</span><span id="line-540">            return getCredentialsPresentation("Cannot create DID for the application instance used in the request - " + presentation.getApplicationInstanceId());</span>
<span class="source-line-no">541</span><span id="line-541">        }</span>
<span class="source-line-no">542</span><span id="line-542">    }</span>
<span class="source-line-no">543</span><span id="line-543"></span>
<span class="source-line-no">544</span><span id="line-544">    private Single&lt;PresentationResult&gt; getCredentialsPresentation(String error) {</span>
<span class="source-line-no">545</span><span id="line-545">        return Single.fromCallable(() -&gt; new PresentationResult(false, null, new Throwable(error)));</span>
<span class="source-line-no">546</span><span id="line-546">    }</span>
<span class="source-line-no">547</span><span id="line-547"></span>
<span class="source-line-no">548</span><span id="line-548">    private VerifiablePresentationMatcherResult findMatchingVerifiableCredentialsForRequest(@NonNull VerifiablePresentationRequest presentationRequest, @NonNull List&lt;VerifiableCredential&gt; credentials) {</span>
<span class="source-line-no">549</span><span id="line-549">        return openIDVerifiableCredentialsClient.filterVerifiableCredentialsMatchingRequest(credentials, presentationRequest);</span>
<span class="source-line-no">550</span><span id="line-550">    }</span>
<span class="source-line-no">551</span><span id="line-551"></span>
<span class="source-line-no">552</span><span id="line-552">    private List&lt;CredentialMatcherResult&gt; findMatchingClaimsForRequest(CredentialRequest credentialRequest, @NonNull List&lt;Claim&gt; claims) {</span>
<span class="source-line-no">553</span><span id="line-553">        final List&lt;RequestedKey&gt; requestedKeys = credentialRequest.getRequestedKeys();</span>
<span class="source-line-no">554</span><span id="line-554">        if (requestedKeys == null) {</span>
<span class="source-line-no">555</span><span id="line-555">            return new ArrayList&lt;&gt;();</span>
<span class="source-line-no">556</span><span id="line-556">        }</span>
<span class="source-line-no">557</span><span id="line-557"></span>
<span class="source-line-no">558</span><span id="line-558">        return ClaimPresentationHelper.getSharesForRequest(requestedKeys, claims);</span>
<span class="source-line-no">559</span><span id="line-559">    }</span>
<span class="source-line-no">560</span><span id="line-560"></span>
<span class="source-line-no">561</span><span id="line-561">    /**</span>
<span class="source-line-no">562</span><span id="line-562">     * Call this method to create a map of self attested claims</span>
<span class="source-line-no">563</span><span id="line-563">     * @param map: Map with key-value pairs for claim</span>
<span class="source-line-no">564</span><span id="line-564">     * @param applicationInstance: ApplicationInstance</span>
<span class="source-line-no">565</span><span id="line-565">     * @return Self-signed Claim object</span>
<span class="source-line-no">566</span><span id="line-566">     */</span>
<span class="source-line-no">567</span><span id="line-567">    public Single&lt;Claim&gt; createSelfClaim(@NonNull final Map&lt;String, String&gt; map, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">568</span><span id="line-568">        NetworkManager networkManager = getNetworkManagerFor(applicationInstance);</span>
<span class="source-line-no">569</span><span id="line-569">        if (networkManager == null) {</span>
<span class="source-line-no">570</span><span id="line-570">            throw new WalletException("Must register the required application instance used in the request - " + applicationInstance.getId().toString());</span>
<span class="source-line-no">571</span><span id="line-571">        }</span>
<span class="source-line-no">572</span><span id="line-572"></span>
<span class="source-line-no">573</span><span id="line-573">        return networkManager.createSelfClaim(map);</span>
<span class="source-line-no">574</span><span id="line-574">    }</span>
<span class="source-line-no">575</span><span id="line-575"></span>
<span class="source-line-no">576</span><span id="line-576">    /**</span>
<span class="source-line-no">577</span><span id="line-577">     * Call this method when a credential is deleted from the Wallet. Reporting this action will help admins view accurate stats on their dashboards in future.</span>
<span class="source-line-no">578</span><span id="line-578">     * @param claim Claim that was deleted from wallet</span>
<span class="source-line-no">579</span><span id="line-579">     */</span>
<span class="source-line-no">580</span><span id="line-580">    @Override</span>
<span class="source-line-no">581</span><span id="line-581">    public void reportCredentialDeletion(@NonNull final Claim claim) {</span>
<span class="source-line-no">582</span><span id="line-582">        final Challenge challenge = new Challenge();</span>
<span class="source-line-no">583</span><span id="line-583">        challenge.setId(claim.getId().toString());</span>
<span class="source-line-no">584</span><span id="line-584">        reportCredentialUpdate(AppEventType.CREDENTIAL_DELETED, true, claim.getIssuer().getData(), challenge, claim.getHolder().getData());</span>
<span class="source-line-no">585</span><span id="line-585">    }</span>
<span class="source-line-no">586</span><span id="line-586"></span>
<span class="source-line-no">587</span><span id="line-587"></span>
<span class="source-line-no">588</span><span id="line-588">    void reportCredentialUpdate(@NonNull final AppEventType eventType, boolean value, @NonNull final String senderId, Challenge challenge, String applicationInstanceId) {</span>
<span class="source-line-no">589</span><span id="line-589">        CredentialEvent credentialEvent = new CredentialEvent(eventType, value ? "TRUE" : "FALSE");</span>
<span class="source-line-no">590</span><span id="line-590">        try {</span>
<span class="source-line-no">591</span><span id="line-591">            sendAppEvent(credentialEvent, senderId, challenge, applicationInstanceId);</span>
<span class="source-line-no">592</span><span id="line-592">        } catch (WalletException exception) {</span>
<span class="source-line-no">593</span><span id="line-593">            Log.d("AppEventException", exception.getMessage());</span>
<span class="source-line-no">594</span><span id="line-594">        }</span>
<span class="source-line-no">595</span><span id="line-595">    }</span>
<span class="source-line-no">596</span><span id="line-596"></span>
<span class="source-line-no">597</span><span id="line-597">    @SuppressLint("CheckResult")</span>
<span class="source-line-no">598</span><span id="line-598">    @SuppressWarnings("ResultOfMethodCallIgnored")</span>
<span class="source-line-no">599</span><span id="line-599">    private void sendAppEvent(@NonNull final AppEvent event, @NonNull final String senderId, Challenge challenge, String applicationInstanceId) {</span>
<span class="source-line-no">600</span><span id="line-600">        final String appEventMessage = new AppEvents(Collections.singletonList(event)).toJson();</span>
<span class="source-line-no">601</span><span id="line-601">        NetworkManager networkManager = networkManagers.get(applicationInstanceId);</span>
<span class="source-line-no">602</span><span id="line-602">        if (networkManager == null) {</span>
<span class="source-line-no">603</span><span id="line-603">            throw new WalletException("Must register the required application instance used in the request" + applicationInstanceId);</span>
<span class="source-line-no">604</span><span id="line-604">        }</span>
<span class="source-line-no">605</span><span id="line-605">        networkManager.sendSecureMessage(senderId, appEventMessage, challenge)</span>
<span class="source-line-no">606</span><span id="line-606">                .subscribeOn(Schedulers.io())</span>
<span class="source-line-no">607</span><span id="line-607">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="source-line-no">608</span><span id="line-608">                .subscribe(</span>
<span class="source-line-no">609</span><span id="line-609">                        () -&gt; Log.i(TAG, "Secure message sent."),</span>
<span class="source-line-no">610</span><span id="line-610">                        throwable -&gt; Log.e(TAG, "Failed to send secure message: ", throwable));</span>
<span class="source-line-no">611</span><span id="line-611"></span>
<span class="source-line-no">612</span><span id="line-612">    }</span>
<span class="source-line-no">613</span><span id="line-613"></span>
<span class="source-line-no">614</span><span id="line-614">    ////////////////////////////////////////////////////////////////////////////////</span>
<span class="source-line-no">615</span><span id="line-615">    ////////////////////////// LinkHandler Implementation //////////////////////////</span>
<span class="source-line-no">616</span><span id="line-616">    ////////////////////////////////////////////////////////////////////////////////</span>
<span class="source-line-no">617</span><span id="line-617"></span>
<span class="source-line-no">618</span><span id="line-618"></span>
<span class="source-line-no">619</span><span id="line-619">    @Override</span>
<span class="source-line-no">620</span><span id="line-620">    public void handleOpenID4VerifiablePresentationRequest(VerifiablePresentationRequest request, OpenIDVerifiableCredentialsClient openIDVerifiableCredentialsClient) {</span>
<span class="source-line-no">621</span><span id="line-621">        walletCallbackHandler.handleCredentialRequest(new PresentationRequest("", null, request));</span>
<span class="source-line-no">622</span><span id="line-622">    }</span>
<span class="source-line-no">623</span><span id="line-623"></span>
<span class="source-line-no">624</span><span id="line-624">    @Override</span>
<span class="source-line-no">625</span><span id="line-625">    public void handleError(Exception e, ApplicationInstance appInstance) {</span>
<span class="source-line-no">626</span><span id="line-626">        handleWalletError(new WalletException("Cannot parse request", e));</span>
<span class="source-line-no">627</span><span id="line-627">    }</span>
<span class="source-line-no">628</span><span id="line-628"></span>
<span class="source-line-no">629</span><span id="line-629">    @Override</span>
<span class="source-line-no">630</span><span id="line-630">    public void handleRequest(Request request, ApplicationInstance appInstance) {</span>
<span class="source-line-no">631</span><span id="line-631">        try {</span>
<span class="source-line-no">632</span><span id="line-632">            final CredentialRequest credentialRequest = CredentialRequest.fromRequest(request);</span>
<span class="source-line-no">633</span><span id="line-633">            if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">634</span><span id="line-634">                this.walletCallbackHandler.handleCredentialRequest(new PresentationRequest(appInstance.getId().toString(), credentialRequest, null));</span>
<span class="source-line-no">635</span><span id="line-635">            }</span>
<span class="source-line-no">636</span><span id="line-636">        } catch (Exception e) {</span>
<span class="source-line-no">637</span><span id="line-637">            Log.e(TAG, "Failed to decode the Request to a known format", e);</span>
<span class="source-line-no">638</span><span id="line-638">            this.handleError(e, appInstance);</span>
<span class="source-line-no">639</span><span id="line-639">        }</span>
<span class="source-line-no">640</span><span id="line-640">    }</span>
<span class="source-line-no">641</span><span id="line-641"></span>
<span class="source-line-no">642</span><span id="line-642">    /////////////////////////////////////////////////////////////////////////////////////</span>
<span class="source-line-no">643</span><span id="line-643">    ////////////////////////// MessageHandler Implementation ////////////////////////////</span>
<span class="source-line-no">644</span><span id="line-644">    /////////////////////////////////////////////////////////////////////////////////////</span>
<span class="source-line-no">645</span><span id="line-645"></span>
<span class="source-line-no">646</span><span id="line-646">    @Override</span>
<span class="source-line-no">647</span><span id="line-647">    public void handleShare(UUID senderId, String message, Challenge challenge, List&lt;Share&gt; shares, List&lt;DidException&gt; errors, ApplicationInstance appInstance) {</span>
<span class="source-line-no">648</span><span id="line-648">        Log.i(TAG, "MessageHandler: handleShare");</span>
<span class="source-line-no">649</span><span id="line-649">        if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">650</span><span id="line-650">            this.walletCallbackHandler.handleCredentialPresentation(senderId.toString(), message, challenge, shares, mapErrors(errors));</span>
<span class="source-line-no">651</span><span id="line-651">        }</span>
<span class="source-line-no">652</span><span id="line-652">    }</span>
<span class="source-line-no">653</span><span id="line-653"></span>
<span class="source-line-no">654</span><span id="line-654">    @Override</span>
<span class="source-line-no">655</span><span id="line-655">    public void handleShareRequest(UUID senderId, String message, Challenge challenge, List&lt;String&gt; shares, ApplicationInstance appInstance) {</span>
<span class="source-line-no">656</span><span id="line-656">        Log.i(TAG, "MessageHandler: handleShareRequest");</span>
<span class="source-line-no">657</span><span id="line-657">        if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">658</span><span id="line-658">            CredentialRequest credentialRequest = new CredentialRequest(null, senderId.toString(), Optional.ofNullable(challenge).orElse(Challenge.create()).getId(), message, null, shares);</span>
<span class="source-line-no">659</span><span id="line-659">            this.walletCallbackHandler.handleCredentialRequest(new PresentationRequest(appInstance.getId().toString(), credentialRequest, null));</span>
<span class="source-line-no">660</span><span id="line-660">        }</span>
<span class="source-line-no">661</span><span id="line-661">    }</span>
<span class="source-line-no">662</span><span id="line-662"></span>
<span class="source-line-no">663</span><span id="line-663">    @Override</span>
<span class="source-line-no">664</span><span id="line-664">    public void handleClaim(UUID sender, String message, Challenge challenge, Claim claim, List&lt;DidException&gt; errors, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">665</span><span id="line-665">        Log.i(TAG, "MessageHandler: handleClaim");</span>
<span class="source-line-no">666</span><span id="line-666">        if (message != null) {</span>
<span class="source-line-no">667</span><span id="line-667">            handleWalletMessage(sender.toString(), message, challenge, applicationInstance);</span>
<span class="source-line-no">668</span><span id="line-668">        }</span>
<span class="source-line-no">669</span><span id="line-669">        if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">670</span><span id="line-670">            reportCredentialUpdate(AppEventType.CREDENTIAL_ISSUANCE_ACCEPTED,</span>
<span class="source-line-no">671</span><span id="line-671">                    this.walletCallbackHandler.handleCredentialIssuance(sender.toString(), message, challenge, claim, mapErrors(errors)),</span>
<span class="source-line-no">672</span><span id="line-672">                    sender.toString(), challenge, applicationInstance.getId().toString());</span>
<span class="source-line-no">673</span><span id="line-673">        }</span>
<span class="source-line-no">674</span><span id="line-674">    }</span>
<span class="source-line-no">675</span><span id="line-675"></span>
<span class="source-line-no">676</span><span id="line-676">    @Override</span>
<span class="source-line-no">677</span><span id="line-677">    public void handleExpiredClaim(UUID sender, String message, Challenge challenge, ClaimReference claimReference, List&lt;DidException&gt; errors, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">678</span><span id="line-678">        Log.i(TAG, "MessageHandler: handleExpiredClaim");</span>
<span class="source-line-no">679</span><span id="line-679">        if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">680</span><span id="line-680">            reportCredentialUpdate(AppEventType.CREDENTIAL_REVOCATION_ACCEPTED,</span>
<span class="source-line-no">681</span><span id="line-681">                    this.walletCallbackHandler.handleCredentialRevocation(sender.toString(), message, challenge, claimReference, mapErrors(errors)),</span>
<span class="source-line-no">682</span><span id="line-682">                    sender.toString(), challenge, applicationInstance.getId().toString());</span>
<span class="source-line-no">683</span><span id="line-683">        }</span>
<span class="source-line-no">684</span><span id="line-684">    }</span>
<span class="source-line-no">685</span><span id="line-685"></span>
<span class="source-line-no">686</span><span id="line-686">    @Override</span>
<span class="source-line-no">687</span><span id="line-687">    public void handleSecureMessage(UUID senderId, String message, Challenge challenge, ApplicationInstance appInstance) {</span>
<span class="source-line-no">688</span><span id="line-688">        Log.i(TAG, "Received secure message from: " + senderId.toString());</span>
<span class="source-line-no">689</span><span id="line-689">        if (message != null) {</span>
<span class="source-line-no">690</span><span id="line-690">            handleWalletMessage(senderId.toString(), message, challenge, appInstance);</span>
<span class="source-line-no">691</span><span id="line-691">        }</span>
<span class="source-line-no">692</span><span id="line-692">    }</span>
<span class="source-line-no">693</span><span id="line-693"></span>
<span class="source-line-no">694</span><span id="line-694">    @Override</span>
<span class="source-line-no">695</span><span id="line-695">    public void handleException(DidException error, ApplicationInstance appInstance) {</span>
<span class="source-line-no">696</span><span id="line-696">        Log.e(TAG, "MessageHandler: handleError", error);</span>
<span class="source-line-no">697</span><span id="line-697">        if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">698</span><span id="line-698">            this.walletCallbackHandler.handleError(new WalletException(error));</span>
<span class="source-line-no">699</span><span id="line-699">        }</span>
<span class="source-line-no">700</span><span id="line-700">    }</span>
<span class="source-line-no">701</span><span id="line-701"></span>
<span class="source-line-no">702</span><span id="line-702">    public void handleWalletError(WalletException err) {</span>
<span class="source-line-no">703</span><span id="line-703">        if (this.walletCallbackHandler != null) {</span>
<span class="source-line-no">704</span><span id="line-704">            this.walletCallbackHandler.handleEvent(new WalletError("WALLET_SDK", err));</span>
<span class="source-line-no">705</span><span id="line-705">        }</span>
<span class="source-line-no">706</span><span id="line-706">    }</span>
<span class="source-line-no">707</span><span id="line-707"></span>
<span class="source-line-no">708</span><span id="line-708">    public void handleWalletMessage(String sender, String message, Challenge challenge, ApplicationInstance applicationInstance) {</span>
<span class="source-line-no">709</span><span id="line-709">        WalletEvent walletEvent;</span>
<span class="source-line-no">710</span><span id="line-710">        switch (WalletMessageParser.getMessageType(message)) {</span>
<span class="source-line-no">711</span><span id="line-711">            case CREDENTIAL_EVENT:</span>
<span class="source-line-no">712</span><span id="line-712">                CredentialMessage credentialMessage = (CredentialMessage) WalletMessageParser.parseMessage(message);</span>
<span class="source-line-no">713</span><span id="line-713">                walletEvent = new WalletCredentialEvent(applicationInstance.getId().toString(), sender, challenge, credentialMessage);</span>
<span class="source-line-no">714</span><span id="line-714">                break;</span>
<span class="source-line-no">715</span><span id="line-715">            case PAIRING_EVENT:</span>
<span class="source-line-no">716</span><span id="line-716">                PairingMessage pairingMessage = (PairingMessage) WalletMessageParser.parseMessage(message);</span>
<span class="source-line-no">717</span><span id="line-717">                walletEvent = new WalletPairingEvent(applicationInstance.getId().toString(), sender, challenge, pairingMessage);</span>
<span class="source-line-no">718</span><span id="line-718">                break;</span>
<span class="source-line-no">719</span><span id="line-719">            case UNKNOWN:</span>
<span class="source-line-no">720</span><span id="line-720">                UnknownMessage unknownMessage = (UnknownMessage) WalletMessageParser.parseMessage(message);</span>
<span class="source-line-no">721</span><span id="line-721">                walletEvent = new UnknownEvent(applicationInstance.getId().toString(), sender, challenge, unknownMessage);</span>
<span class="source-line-no">722</span><span id="line-722">                break;</span>
<span class="source-line-no">723</span><span id="line-723">            default:</span>
<span class="source-line-no">724</span><span id="line-724">                walletEvent = new UnknownEvent(applicationInstance.getId().toString(), sender, challenge, new UnknownMessage(message));</span>
<span class="source-line-no">725</span><span id="line-725">        }</span>
<span class="source-line-no">726</span><span id="line-726">        this.walletCallbackHandler.handleEvent(walletEvent);</span>
<span class="source-line-no">727</span><span id="line-727">    }</span>
<span class="source-line-no">728</span><span id="line-728"></span>
<span class="source-line-no">729</span><span id="line-729">    private List&lt;WalletException&gt; mapErrors(List&lt;DidException&gt; didExceptions) {</span>
<span class="source-line-no">730</span><span id="line-730">        return didExceptions.stream().map(WalletException::new).collect(Collectors.toList());</span>
<span class="source-line-no">731</span><span id="line-731">    }</span>
<span class="source-line-no">732</span><span id="line-732"></span>
<span class="source-line-no">733</span><span id="line-733">    /////////////////////////////////////////////////////////////////////////////////////</span>
<span class="source-line-no">734</span><span id="line-734">    /////////////////////////// PingOneWalletClient Builder /////////////////////////////</span>
<span class="source-line-no">735</span><span id="line-735">    /////////////////////////////////////////////////////////////////////////////////////</span>
<span class="source-line-no">736</span><span id="line-736">    public static class Builder {</span>
<span class="source-line-no">737</span><span id="line-737"></span>
<span class="source-line-no">738</span><span id="line-738">        private StorageManagerContract storageManagerContract;</span>
<span class="source-line-no">739</span><span id="line-739">        private StorageErrorHandler storageErrorHandler;</span>
<span class="source-line-no">740</span><span id="line-740">        private final Map&lt;PingOneRegion, ApplicationInstance&gt; applicationInstances = new HashMap&lt;&gt;();</span>
<span class="source-line-no">741</span><span id="line-741">        private WalletCallbackHandler walletCallbackHandler;</span>
<span class="source-line-no">742</span><span id="line-742">        private boolean allowOtherRegions = true;</span>
<span class="source-line-no">743</span><span id="line-743">        private String pushToken;</span>
<span class="source-line-no">744</span><span id="line-744"></span>
<span class="source-line-no">745</span><span id="line-745">        private final CompositeDisposable disposables = new CompositeDisposable();</span>
<span class="source-line-no">746</span><span id="line-746"></span>
<span class="source-line-no">747</span><span id="line-747">        public Builder() {</span>
<span class="source-line-no">748</span><span id="line-748">        }</span>
<span class="source-line-no">749</span><span id="line-749"></span>
<span class="source-line-no">750</span><span id="line-750">        /**</span>
<span class="source-line-no">751</span><span id="line-751">         * Initialize Builder for PingOne region(s).</span>
<span class="source-line-no">752</span><span id="line-752">         * SDK will register the wallet in the region(s) passed here at the time of initialization.</span>
<span class="source-line-no">753</span><span id="line-753">         * If allowOtherRegions is set to true, wallet will automatically register to the new region at the time of the request.</span>
<span class="source-line-no">754</span><span id="line-754">         * If allowOtherRegions is set to false, wallet will throw error when trying to perform an action in unsupported regions.</span>
<span class="source-line-no">755</span><span id="line-755">         * @param allowOtherRegions: PingOneRegion for wallet initialization</span>
<span class="source-line-no">756</span><span id="line-756">         * @param pingOneRegion: boolean indiciating if wallet can be registered in other regions</span>
<span class="source-line-no">757</span><span id="line-757">         */</span>
<span class="source-line-no">758</span><span id="line-758">        public Builder(boolean allowOtherRegions, PingOneRegion... pingOneRegion) {</span>
<span class="source-line-no">759</span><span id="line-759">            Arrays.stream(pingOneRegion).forEach(region -&gt; applicationInstances.put(region, null));</span>
<span class="source-line-no">760</span><span id="line-760">            this.allowOtherRegions = allowOtherRegions;</span>
<span class="source-line-no">761</span><span id="line-761">        }</span>
<span class="source-line-no">762</span><span id="line-762"></span>
<span class="source-line-no">763</span><span id="line-763">        /**</span>
<span class="source-line-no">764</span><span id="line-764">         * Optional: Pass the custom implementation of StorageManagerContract interface.</span>
<span class="source-line-no">765</span><span id="line-765">         * SDK already has a default implementation of StorageManagerContract that utilizes the crypto keys from secure enclave. Override the implementation only if needed.</span>
<span class="source-line-no">766</span><span id="line-766">         * @param storageManagerContract: Custom implementation of StorageManagerContract</span>
<span class="source-line-no">767</span><span id="line-767">         * @return PingOneWalletClient.Builder</span>
<span class="source-line-no">768</span><span id="line-768">         */</span>
<span class="source-line-no">769</span><span id="line-769">        public Builder setStorageManager(StorageManagerContract storageManagerContract) {</span>
<span class="source-line-no">770</span><span id="line-770">            this.storageManagerContract = storageManagerContract;</span>
<span class="source-line-no">771</span><span id="line-771">            return this;</span>
<span class="source-line-no">772</span><span id="line-772">        }</span>
<span class="source-line-no">773</span><span id="line-773"></span>
<span class="source-line-no">774</span><span id="line-774">        /**</span>
<span class="source-line-no">775</span><span id="line-775">         * Optional: Pass the error handler to handle errors thrown when initializing storage</span>
<span class="source-line-no">776</span><span id="line-776">         * @param storageErrorHandler: StorageErrorHandler</span>
<span class="source-line-no">777</span><span id="line-777">         * @return PingOneWalletClient.Builder</span>
<span class="source-line-no">778</span><span id="line-778">         * @see StorageErrorHandler</span>
<span class="source-line-no">779</span><span id="line-779">         */</span>
<span class="source-line-no">780</span><span id="line-780">        public Builder setStorageErrorHandler(StorageErrorHandler storageErrorHandler) {</span>
<span class="source-line-no">781</span><span id="line-781">            this.storageErrorHandler = storageErrorHandler;</span>
<span class="source-line-no">782</span><span id="line-782">            return this;</span>
<span class="source-line-no">783</span><span id="line-783">        }</span>
<span class="source-line-no">784</span><span id="line-784"></span>
<span class="source-line-no">785</span><span id="line-785">        /**</span>
<span class="source-line-no">786</span><span id="line-786">         * Required: Pass the callback handler to handle different Wallet actions</span>
<span class="source-line-no">787</span><span id="line-787">         * @param walletCallbackHandler: Implementation of WalletCallbackHandler</span>
<span class="source-line-no">788</span><span id="line-788">         * @return PingOneWalletClient.Builder</span>
<span class="source-line-no">789</span><span id="line-789">         * @see WalletCallbackHandler</span>
<span class="source-line-no">790</span><span id="line-790">         */</span>
<span class="source-line-no">791</span><span id="line-791">        public Builder setWalletCallbackHandler(WalletCallbackHandler walletCallbackHandler) {</span>
<span class="source-line-no">792</span><span id="line-792">            this.walletCallbackHandler = walletCallbackHandler;</span>
<span class="source-line-no">793</span><span id="line-793">            return this;</span>
<span class="source-line-no">794</span><span id="line-794">        }</span>
<span class="source-line-no">795</span><span id="line-795"></span>
<span class="source-line-no">796</span><span id="line-796">        /**</span>
<span class="source-line-no">797</span><span id="line-797">         * Optional: Pass the push token for the application if available. You can set the value later using PingOneWalletClient as well.</span>
<span class="source-line-no">798</span><span id="line-798">         * @param pushToken: Firebase token for the application</span>
<span class="source-line-no">799</span><span id="line-799">         * @return PingOneWalletClient.Builder</span>
<span class="source-line-no">800</span><span id="line-800">         */</span>
<span class="source-line-no">801</span><span id="line-801">        public Builder setPushToken(String pushToken) {</span>
<span class="source-line-no">802</span><span id="line-802">            this.pushToken = pushToken;</span>
<span class="source-line-no">803</span><span id="line-803">            return this;</span>
<span class="source-line-no">804</span><span id="line-804">        }</span>
<span class="source-line-no">805</span><span id="line-805"></span>
<span class="source-line-no">806</span><span id="line-806">        /**</span>
<span class="source-line-no">807</span><span id="line-807">         * Call to initialize PingOneWalletClient after passing all the parameters.</span>
<span class="source-line-no">808</span><span id="line-808">         * @param fragmentActivity: context</span>
<span class="source-line-no">809</span><span id="line-809">         * @param onResult: called if initialization is successful</span>
<span class="source-line-no">810</span><span id="line-810">         * @param onError: called if initialization fails</span>
<span class="source-line-no">811</span><span id="line-811">         */</span>
<span class="source-line-no">812</span><span id="line-812">        public void build(FragmentActivity fragmentActivity, Consumer&lt;PingOneWalletClient&gt; onResult, Consumer&lt;Throwable&gt; onError) {</span>
<span class="source-line-no">813</span><span id="line-813">            initStorageManager(fragmentActivity, new CompletionHandler&lt;StorageManagerContract&gt;() {</span>
<span class="source-line-no">814</span><span id="line-814">                @Override</span>
<span class="source-line-no">815</span><span id="line-815">                public void onSuccess(StorageManagerContract storage) {</span>
<span class="source-line-no">816</span><span id="line-816">                    PingOneWalletClient client = new PingOneWalletClient(fragmentActivity.getPackageName(), storage, walletCallbackHandler, allowOtherRegions);</span>
<span class="source-line-no">817</span><span id="line-817"></span>
<span class="source-line-no">818</span><span id="line-818">                    if (applicationInstances.isEmpty()) {</span>
<span class="source-line-no">819</span><span id="line-819">                        onResult.accept(client);</span>
<span class="source-line-no">820</span><span id="line-820">                        return;</span>
<span class="source-line-no">821</span><span id="line-821">                    }</span>
<span class="source-line-no">822</span><span id="line-822"></span>
<span class="source-line-no">823</span><span id="line-823">                    handleApplicationInstanceInitialization(applicationInstances, 0, null, pushToken, client, () -&gt; {</span>
<span class="source-line-no">824</span><span id="line-824">                        disposables.clear();</span>
<span class="source-line-no">825</span><span id="line-825">                        onResult.accept(client);</span>
<span class="source-line-no">826</span><span id="line-826">                    });</span>
<span class="source-line-no">827</span><span id="line-827"></span>
<span class="source-line-no">828</span><span id="line-828">                }</span>
<span class="source-line-no">829</span><span id="line-829"></span>
<span class="source-line-no">830</span><span id="line-830">                @Override</span>
<span class="source-line-no">831</span><span id="line-831">                public void onFailure(Throwable e) {</span>
<span class="source-line-no">832</span><span id="line-832">                    onError.accept(e);</span>
<span class="source-line-no">833</span><span id="line-833">                }</span>
<span class="source-line-no">834</span><span id="line-834">            });</span>
<span class="source-line-no">835</span><span id="line-835">        }</span>
<span class="source-line-no">836</span><span id="line-836"></span>
<span class="source-line-no">837</span><span id="line-837">        private void handleApplicationInstanceInitialization(Map&lt;PingOneRegion, ApplicationInstance&gt; entries, int index, JsonWebKeySet clientJwks, String pushToken, PingOneWalletClient client, Runnable runnable) {</span>
<span class="source-line-no">838</span><span id="line-838">            if (index == entries.size() - 1) {</span>
<span class="source-line-no">839</span><span id="line-839">                runnable.run();</span>
<span class="source-line-no">840</span><span id="line-840">                return;</span>
<span class="source-line-no">841</span><span id="line-841">            }</span>
<span class="source-line-no">842</span><span id="line-842"></span>
<span class="source-line-no">843</span><span id="line-843">            Map.Entry&lt;PingOneRegion, ApplicationInstance&gt; nextEntry = new ArrayList&lt;&gt;(entries.entrySet()).get(index);</span>
<span class="source-line-no">844</span><span id="line-844">            PingOneRegion region = nextEntry.getKey();</span>
<span class="source-line-no">845</span><span id="line-845">            ApplicationInstance instance = nextEntry.getValue();</span>
<span class="source-line-no">846</span><span id="line-846"></span>
<span class="source-line-no">847</span><span id="line-847">            if (instance == null) {</span>
<span class="source-line-no">848</span><span id="line-848">                disposables.add(registerNewApplicationInstance(region, clientJwks, pushToken).subscribe(applicationInstance -&gt; {</span>
<span class="source-line-no">849</span><span id="line-849">                    setApplicationInstanceFor(region, applicationInstance);</span>
<span class="source-line-no">850</span><span id="line-850">                    client.dataRepository.saveApplicationInstance(region, applicationInstance);</span>
<span class="source-line-no">851</span><span id="line-851">                    handleApplicationInstanceInitialization(entries, index + 1, applicationInstance.getJwks(), pushToken != null ? pushToken : applicationInstance.getPushToken(), client, runnable);</span>
<span class="source-line-no">852</span><span id="line-852">                }));</span>
<span class="source-line-no">853</span><span id="line-853">            }</span>
<span class="source-line-no">854</span><span id="line-854">        }</span>
<span class="source-line-no">855</span><span id="line-855"></span>
<span class="source-line-no">856</span><span id="line-856">        private void initStorageManager(FragmentActivity activity, CompletionHandler&lt;StorageManagerContract&gt; onResult) {</span>
<span class="source-line-no">857</span><span id="line-857">            if (storageManagerContract != null) {</span>
<span class="source-line-no">858</span><span id="line-858">                storageManagerContract.setStorageErrorHandler(storageErrorHandler);</span>
<span class="source-line-no">859</span><span id="line-859">                onResult.onSuccess(storageManagerContract);</span>
<span class="source-line-no">860</span><span id="line-860">            } else {</span>
<span class="source-line-no">861</span><span id="line-861">                StorageManagerImpl.initialize(new WeakReference&lt;&gt;(activity), storageErrorHandler, onResult);</span>
<span class="source-line-no">862</span><span id="line-862">            }</span>
<span class="source-line-no">863</span><span id="line-863"></span>
<span class="source-line-no">864</span><span id="line-864">        }</span>
<span class="source-line-no">865</span><span id="line-865"></span>
<span class="source-line-no">866</span><span id="line-866">    }</span>
<span class="source-line-no">867</span><span id="line-867"></span>
<span class="source-line-no">868</span><span id="line-868">    private static Single&lt;ApplicationInstance&gt; registerNewApplicationInstance(PingOneRegion walletRegion, JsonWebKeySet jwks, String pushToken) {</span>
<span class="source-line-no">869</span><span id="line-869">        JsonWebKeySet clientJwks = jwks != null ? jwks : new JwksGenerator().generate();</span>
<span class="source-line-no">870</span><span id="line-870">        boolean pushSandBox = BuildConfig.DEBUG;</span>
<span class="source-line-no">871</span><span id="line-871">        return Single.fromCallable(() -&gt; new ApplicationInstanceCreator()</span>
<span class="source-line-no">872</span><span id="line-872">                        .withPingApiBaseUrl(walletRegion.getBaseUrl())</span>
<span class="source-line-no">873</span><span id="line-873">                        .createForAndroid(clientJwks, pushToken, pushSandBox, UUID.randomUUID(), UUID.randomUUID(), UUID.randomUUID()))</span>
<span class="source-line-no">874</span><span id="line-874">                .subscribeOn(Schedulers.io())</span>
<span class="source-line-no">875</span><span id="line-875">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="source-line-no">876</span><span id="line-876">                .doOnError(throwable -&gt; Log.e(TAG, "Failed to create application instance", throwable));</span>
<span class="source-line-no">877</span><span id="line-877">    }</span>
<span class="source-line-no">878</span><span id="line-878"></span>
<span class="source-line-no">879</span><span id="line-879">}</span>




























































</pre>
</div>
</main>
</body>
</html>
